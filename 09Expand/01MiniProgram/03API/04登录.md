### 1.封装获取code

```js
export default () => {
  return new Promise(resolve => {
    wx.login({ success: res => resolve(res.code) })
  })
}
```

### 2.登录逻辑

```js
import { loginRequest } from "../../service/index"
import getCode from "../../service/login"

Page({
  async onShow() {
    // 判断是否有token
    const token = wx.getStorageSync('token')

    if(!token) {
      this.getToken()
    } else {
      // 判断token是否过期
      const res = await loginRequest.post({
        url: "/auth",
        header: { token }
      })

      if(res.message === "已登录") {
        console.log("请求其他数据");
      } else {
        this.getToken()
      }
    }
  },
  async getToken() {
    const code = await getCode()

    const res = await loginRequest.post({
      url: "/login",
      data: { code }
    })
    wx.setStorageSync('token', res.token)
  }
})
```

