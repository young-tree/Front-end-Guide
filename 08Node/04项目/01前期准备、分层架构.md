### 1.前期准备

- koa @koa/router koa-bodyparser @types/node 以及其他类型声明包
- 加入tsconfig.json文件，加入脚本：<img src="images/image-20221119205444021.png" alt="image-20221119205444021" style="zoom:50%;" />
- 服务器简单搭建：<img src="images/image-20221119205632913.png" alt="image-20221119205632913" style="zoom: 50%;" />

### 2.配置文件

- 目录结构：<img src="images/image-20221119214103705.png" alt="image-20221119214103705" style="zoom:50%;" />，在.env文件中定义端口号:<img src="images/image-20221119214139256.png" alt="image-20221119214139256" style="zoom:50%;" />
- 安装dotenv库，通过dotenv加载变量，在serve.ts中导出端口号：<img src="images/image-20221119214251675.png" alt="image-20221119214251675" style="zoom:50%;" />
- 在main.ts中导入并使用端口号：<img src="images/image-20221119214338828.png" alt="image-20221119214338828" style="zoom:50%;" />

### 3.路由和app的抽取

- 目录结构：<img src="images/image-20221119215350186.png" alt="image-20221119215350186" style="zoom:50%;" />

- 路由的抽取：<img src="images/image-20221119215003970.png" alt="image-20221119215003970" style="zoom:50%;" />

  

- app的抽取：<img src="images/image-20221119215506458.png" alt="image-20221119215506458" style="zoom:50%;" />

  

- main.ts剩余代码：<img src="images/image-20221119215537457.png" alt="image-20221119215537457" style="zoom:50%;" />

### 4.用户注册接口所引发的问题

- 代码示例：<img src="images/image-20221119222614127.png" alt="image-20221119222614127" style="zoom:50%;" />
- 问题一：代码报错，这是因为我们使用了bodyparser，还缺少co-body和qs库，安装即可
- 问题二：用户注册接口的逻辑可不仅仅只有这么一点，而且我们以后还要写很多关于用户的接口
  - 所以我们应该进行代码抽取，目录结构：<img src="images/image-20221120173517457.png" alt="image-20221120173517457" style="zoom:50%;" />
  - user.controller.ts：<img src="images/image-20221120173554649.png" alt="image-20221120173554649" style="zoom:50%;" />
  - user.router.ts：<img src="images/image-20221120173634522.png" alt="image-20221120173634522" style="zoom:50%;" />
- 问题三：在controller中的代码还需要进行数据库方面的操作，这些操作也是很复杂的，也需要抽取
  - 目录结构：<img src="images/image-20221120174652006.png" alt="image-20221120174652006" style="zoom:50%;" />
  - user.service.ts：<img src="images/image-20221120174822805.png" alt="image-20221120174822805" style="zoom:50%;" />
  - user.controller.ts：<img src="images/image-20221120174917391.png" alt="image-20221120174917391" style="zoom:50%;" />

### 5.数据库相关操作

- 安装数据库驱动：mysql2
- 目录结构：<img src="images/image-20221120190553589.png" alt="image-20221120190553589" style="zoom:50%;" />，database.ts：<img src="images/image-20221120191150037.png" alt="image-20221120191150037" style="zoom:50%;" />
- user.service.ts：<img src="images/image-20221120191737458.png" alt="image-20221120191737458" style="zoom:50%;" />

### 6.向数据库存储一个用户

- user.service.ts：<img src="images/image-20221120194516643.png" alt="image-20221120194516643" style="zoom:50%;" />

  

- user.controller.ts：<img src="images/image-20221120194606889.png" alt="image-20221120194606889" style="zoom:50%;" />

- 请求和结果：<img src="images/image-20221120194746307.png" alt="image-20221120194746307" style="zoom:50%;" />

### 7.分层架构总结

- 目录结构：<img src="images/image-20221120195015826.png" alt="image-20221120195015826" style="zoom:50%;" />
- main.ts：入口文件，监听某一个端口，同时启动服务器
  - .env和config：设置端口号
  - app中的index.ts：应用路由，并将app导出，供main.ts使用
- router文件夹：书写路由，但是路由的中间件交给其他文件
  - controller文件夹：书写路由中间件，但是一些数据库的操作要交给其他文件
- service文件夹：书写数据库相关操作，具体执行哪些sql语句等
  - app中的database.ts：连接数据库，给到service中的文件使用



- main.ts => config/server.ts => .env
  - 主文件（监听端口号启动服务器） => 端口号的寻找和导出 => 存储端口号
- main.ts => app/index.ts => router/index.ts => router/user.router.ts => controller/user.controller.ts => service/user.service.ts => app/database.ts
  - 主文件 => 生效路由/解析/规则 => 创建路由/应用中间件 => 书写中间件/获取传递过来的参数/数据库操作/给客户端返回结果 => 执行sql语句/进行相关判断 => 连接数据库/提供连接