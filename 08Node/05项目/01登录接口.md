### 1.创建登录路由

- 目录结构和代码示例：<img src="images/image-20221125075758650.png" alt="image-20221125075758650" style="zoom:50%;" /><img src="images/image-20221125075822175.png" alt="image-20221125075822175" style="zoom:50%;" /><img src="images/image-20221125075905576.png" alt="image-20221125075905576" style="zoom:50%;" />
- 代码结构：目录结构：<img src="images/image-20221125091449256.png" alt="image-20221125091449256" style="zoom:50%;" />，middleware中进行验证，判断密码是否为空以及其他验证，验证通过，进入controller中间件，颁发令牌
  - login.router：注册中间件：<img src="images/image-20221125091816880.png" alt="image-20221125091816880" style="zoom:50%;" />
  - login.middleware：verifyLogin中间件处理验证问题：<img src="images/image-20221125092027369.png" alt="image-20221125092027369" style="zoom:50%;" />
  - login.controller.ts：sign中间件处理颁发令牌问题：<img src="images/image-20221125092123312.png" alt="image-20221125092123312" style="zoom:50%;" />

### 2.查询数据库

- 验证用户是否存在：目录结构：<img src="images/image-20221125093329369.png" alt="image-20221125093329369" style="zoom:50%;" />，error：错误常量，middleware调用数据库操作，handle.error：处理错误
- 验证用户名是否存在，密码是否正确：<img src="images/image-20221125094032434.png" alt="image-20221125094032434" style="zoom:50%;" />

### 3.颁发token

- 传递数据，login.middleware：<img src="images/image-20221125100018675.png" alt="image-20221125100018675" style="zoom:50%;" />
- 读取秘钥：<img src="images/image-20221125100058861.png" alt="image-20221125100058861" style="zoom:50%;" /><img src="images/image-20221125100113579.png" alt="image-20221125100113579" style="zoom:50%;" />
  - 这里读取秘钥存在路径问题，这个问题跟我们的启动目录有关：<img src="images/image-20221125100327732.png" alt="image-20221125100327732" style="zoom:50%;" />
  - 需要这么写：<img src="images/image-20221125100436168.png" alt="image-20221125100436168" style="zoom: 50%;" />
  - 也可以使用相对路径：<img src="images/image-20221125100717237.png" alt="image-20221125100717237" style="zoom:50%;" />
- 颁发token：<img src="images/image-20221125100752796.png" alt="image-20221125100752796" style="zoom:50%;" />，要测试，时间写了两分钟，一般一个周或月
  - 结果：<img src="images/image-20221125100708633.png" alt="image-20221125100708633" style="zoom:50%;" />

### 4.验证token

- login.router.ts：<img src="images/image-20221125132142920.png" alt="image-20221125132142920" style="zoom:50%;" />，注册test接口，使用test中间件
- login.controller.ts：<img src="images/image-20221126135409556.png" alt="image-20221126135409556" style="zoom:50%;" />，验证token

### 5.验证token的封装

- 不仅仅是/login/test这个接口会验证token，其他的接口，比如我的信息，评论等等都需要验证token
  - 所以我们应该把它封装为一个中间件
- login.middleware.ts：<img src="images/image-20221125133600756.png" alt="image-20221125133600756" style="zoom:50%;" />，书写验证代码
- login.router.ts：<img src="images/image-20221125133654892.png" alt="image-20221125133654892" style="zoom:50%;" />，使用验证token的中间件

- 登录时将token加入到postman的全局中：<img src="images/image-20221125134133852.png" alt="image-20221125134133852" style="zoom:50%;" />
  - 第一行：pm代表postman，它的结果用json进行解析
  - 第二行：将解析的结果以token命名，设置到postman的全局变量中

### 6.动态的注册所有路由对象

- 让router能够生效我们每次都需要在app/index.ts中写这些代码：<img src="images/image-20221125142114310.png" alt="image-20221125142114310" style="zoom:50%;" />
  - 很麻烦，我们想有没有什么办法可以自动化生成这些代码
- 目录结构：<img src="images/image-20221125143335797.png" alt="image-20221125143335797" style="zoom:50%;" />，在router/index.ts中获取router对象，并通过app注册router
  - app得去app/index.ts中拿，所以要获取router/index.ts中的函数，把app作为参数传过去
- router/index：<img src="images/image-20221125143548820.png" alt="image-20221125143548820" style="zoom: 50%;" />，app/index：<img src="images/image-20221125143615140.png" alt="image-20221125143615140" style="zoom:50%;" />

